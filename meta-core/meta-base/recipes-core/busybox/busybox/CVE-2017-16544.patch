From bf2d29b5fc91f64bf781dd2581d4e588d023c3cb Mon Sep 17 00:00:00 2001
From: Benxi Liu <bxliu@linux.alibaba.com>
Date: Tue, 29 Jan 2019 19:03:28 +0800
Subject: [PATCH] lineedit: do not tab-complete any strings which have
 control characters

function                                             old     new   delta
add_match                                             41      68     +27

Signed-off-by: Denys Vlasenko <vda.linux@googlemail.com>

The patch comes from:
https://git.busybox.net/busybox/commit/?id=c3797d40a1c57352192c6106cc0f435e7d9c11e8

CVE: CVE-2017-16544
Upstream-Status: Backport

Signed-off-by: Benxi Liu <bxliu@linux.alibaba.com>
---
 libbb/lineedit.c | 12 ++++++++++++
 1 file changed, 12 insertions(+)

diff --git a/libbb/lineedit.c b/libbb/lineedit.c
index a83e07c..2fcacbe 100644
--- a/libbb/lineedit.c
+++ b/libbb/lineedit.c
@@ -631,6 +631,18 @@ static void free_tab_completion_data(void)
 
 static void add_match(char *matched)
 {
+	unsigned char *p = (unsigned char*)matched;
+	while (*p) {
+		/* ESC attack fix: drop any string with control chars */
+		if (*p < ' '
+		 || (!ENABLE_UNICODE_SUPPORT && *p >= 0x7f)
+		 || (ENABLE_UNICODE_SUPPORT && *p == 0x7f)
+		) {
+			free(matched);
+			return;
+		}
+		p++;
+	}
 	matches = xrealloc_vector(matches, 4, num_matches);
 	matches[num_matches] = matched;
 	num_matches++;
-- 
2.7.4

