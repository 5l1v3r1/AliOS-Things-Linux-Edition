From 908792e7aa4e50d3d6048ef1800ca7425c1a2c09 Mon Sep 17 00:00:00 2001
From: Wang Yangjie <yangjiewang@linux.alibaba.com>
Date: Fri, 29 Mar 2019 10:16:14 +0800
Subject: [PATCH] Fix LTP test failed on setgid and cve-2017-5669

Revert the below commit:
 - ipc/shm: fix shmat() nil address after round-down when remapping
   commit 8f89c007b6dec16a1793cb88de88fcc02117bbbc upstream

 - revert "ipc/shm: Fix shmat mmap nil-page protection"
   commit 2ef44a3c1a32656dbae30cd16ec5c22a996a4ca9 upstream

 - Fix up non-directory creation in SGID directories
   commit 0fa3ecd87848c9c93c2c828ef4c3a8ca36ce46c7 upstream
---
 fs/inode.c |  6 ------
 ipc/shm.c  | 19 ++++++++-----------
 2 files changed, 8 insertions(+), 17 deletions(-)

diff --git a/fs/inode.c b/fs/inode.c
index 23dfb4f..9b8856b 100644
--- a/fs/inode.c
+++ b/fs/inode.c
@@ -2004,14 +2004,8 @@ void inode_init_owner(struct inode *inode, const struct inode *dir,
 	inode->i_uid = current_fsuid();
 	if (dir && dir->i_mode & S_ISGID) {
 		inode->i_gid = dir->i_gid;
-
-		/* Directories are special, and always inherit S_ISGID */
 		if (S_ISDIR(mode))
 			mode |= S_ISGID;
-		else if ((mode & (S_ISGID | S_IXGRP)) == (S_ISGID | S_IXGRP) &&
-			 !in_group_p(inode->i_gid) &&
-			 !capable_wrt_inode_uidgid(dir, CAP_FSETID))
-			mode &= ~S_ISGID;
 	} else
 		inode->i_gid = current_fsgid();
 	inode->i_mode = mode;
diff --git a/ipc/shm.c b/ipc/shm.c
index 9c687cd..b626745 100644
--- a/ipc/shm.c
+++ b/ipc/shm.c
@@ -1127,17 +1127,14 @@ long do_shmat(int shmid, char __user *shmaddr, int shmflg,
 		goto out;
 	else if ((addr = (ulong)shmaddr)) {
 		if (addr & (shmlba - 1)) {
-			if (shmflg & SHM_RND) {
-				addr &= ~(shmlba - 1);  /* round down */
-
-				/*
-				 * Ensure that the round-down is non-nil
-				 * when remapping. This can happen for
-				 * cases when addr < shmlba.
-				 */
-				if (!addr && (shmflg & SHM_REMAP))
-					goto out;
-			} else
+			/*
+			 * Round down to the nearest multiple of shmlba.
+			 * For sane do_mmap_pgoff() parameters, avoid
+			 * round downs that trigger nil-page and MAP_FIXED.
+			 */
+			if ((shmflg & SHM_RND) && addr >= shmlba)
+				addr &= ~(shmlba - 1);
+			else
 #ifndef __ARCH_FORCE_SHMLBA
 				if (addr & ~PAGE_MASK)
 #endif
-- 
2.7.4

