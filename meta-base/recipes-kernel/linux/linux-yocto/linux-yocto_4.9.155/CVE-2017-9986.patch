From b43c4724e1b815d531495d40d554a533c129b09e Mon Sep 17 00:00:00 2001
From: Benxi Liu <bxliu@linux.alibaba.com>
Date: Wed, 27 Feb 2019 19:42:56 +0800
Subject: [PATCH] Fix Bug 196135: Double fetch problem in msnd_pinnacle.c

The patch comes from:
https://bugzilla.kernel.org/show_bug.cgi?id=196135

CVE: CVE-2017-9986
Upstream-Status: Pending

Signed-off-by: Benxi Liu <bxliu@linux.alibaba.com>
---
 sound/oss/msnd_pinnacle.c | 12 +++++++++---
 1 file changed, 9 insertions(+), 3 deletions(-)

diff --git a/sound/oss/msnd_pinnacle.c b/sound/oss/msnd_pinnacle.c
index a8bb4a0..7d721ea 100644
--- a/sound/oss/msnd_pinnacle.c
+++ b/sound/oss/msnd_pinnacle.c
@@ -1103,15 +1103,21 @@ static irqreturn_t intr(int irq, void *dev_id)
 	msnd_inb(dev.io + HP_RXL);
 
 	/* Evaluate queued DSP messages */
-	while (readw(dev.DSPQ + JQS_wTail) != readw(dev.DSPQ + JQS_wHead)) {
+	register WORD head = readw(dev.DSPQ + JQS_wHead);
+	register WORD tail = readw(dev.DSPQ + JQS_wTail);
+
+	while (tail != head) {
 		register WORD wTmp;
 
-		eval_dsp_msg(readw(dev.pwDSPQData + 2*readw(dev.DSPQ + JQS_wHead)));
+		eval_dsp_msg(readw(dev.pwDSPQData + 2*head));
 
-		if ((wTmp = readw(dev.DSPQ + JQS_wHead) + 1) > readw(dev.DSPQ + JQS_wSize))
+		if ((wTmp = head + 1) > readw(dev.DSPQ + JQS_wSize))
 			writew(0, dev.DSPQ + JQS_wHead);
 		else
 			writew(wTmp, dev.DSPQ + JQS_wHead);
+
+		head = readw(dev.DSPQ + JQS_wHead);
+		tail = readw(dev.DSPQ + JQS_wTail);
 	}
 	return IRQ_HANDLED;
 }
-- 
2.7.4

